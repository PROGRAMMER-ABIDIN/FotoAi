<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Deteksi Kamera AI + Suara</title>
  <style>
    body {
      background-color: #111;
      color: white;
      text-align: center;
      font-family: sans-serif;
    }
    video, canvas {
      border: 2px solid #fff;
      border-radius: 10px;
      margin: 10px;
      width: 80%;
      max-width: 500px;
    }
    #status {
      font-size: 1.2em;
      margin-top: 20px;
      padding: 10px;
      background: #222;
      border-radius: 10px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h1>AI Kamera dengan Suara</h1>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" hidden></canvas>
  <div id="status">Memuat kamera...</div>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const statusText = document.getElementById("status");

    let lastSpoken = ""; // untuk hindari pengulangan suara

    // üîä Fungsi bicara
    function speak(text) {
      if (text === lastSpoken) return;
      lastSpoken = text;

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "id-ID";
      window.speechSynthesis.cancel(); // hentikan yang sedang bicara
      window.speechSynthesis.speak(utterance);
    }

    // üé• Aktifkan kamera
    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
      .then((stream) => {
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          startDetection();
        };
      })
      .catch((err) => {
        statusText.innerText = "Gagal mengakses kamera: " + err.message;
        speak("Gagal membuka kamera");
      });

    // üîç Analisis posisi & gerakan
    function startDetection() {
      const ctx = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      let lastFrame = null;

      setInterval(() => {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const stability = getImageDifference(lastFrame, frame);

        const tilt = detectTilt(ctx, canvas);

        let status = "";

        if (stability > 50) {
          status = "üì∏ Kamera tidak stabil! Harap diamkan.";
          speak("Kamera tidak stabil, harap pegang dengan mantap.");
        } else if (tilt.horizontal > 10) {
          status = "‚Ü™Ô∏è Kamera miring ke kanan.";
          speak("Posisi kamera miring ke kanan.");
        } else if (tilt.horizontal < -10) {
          status = "‚Ü©Ô∏è Kamera miring ke kiri.";
          speak("Posisi kamera miring ke kiri.");
        } else if (tilt.vertical > 10) {
          status = "üîΩ Kamera terlalu menghadap ke bawah.";
          speak("Kamera menghadap terlalu ke bawah.");
        } else if (tilt.vertical < -10) {
          status = "üîº Kamera terlalu menghadap ke atas.";
          speak("Kamera menghadap terlalu ke atas.");
        } else {
          status = "‚úÖ Kamera stabil & posisi bagus.";
          speak("Kamera dalam posisi bagus, silakan ambil gambar.");
        }

        statusText.innerText = status;
        lastFrame = frame;
      }, 1000);
    }

    // üì∑ Deteksi gerakan dari frame sebelumnya
    function getImageDifference(frame1, frame2) {
      if (!frame1 || !frame2) return 0;
      let diff = 0;
      for (let i = 0; i < frame1.data.length; i += 4) {
        const avg1 = (frame1.data[i] + frame1.data[i + 1] + frame1.data[i + 2]) / 3;
        const avg2 = (frame2.data[i] + frame2.data[i + 1] + frame2.data[i + 2]) / 3;
        diff += Math.abs(avg1 - avg2);
      }
      return diff / (frame1.data.length / 4);
    }

    // üéØ Deteksi kemiringan dengan distribusi cahaya
    function detectTilt(ctx, canvas) {
      const width = canvas.width;
      const height = canvas.height;

      const image = ctx.getImageData(0, 0, width, height);
      let left = 0, right = 0, top = 0, bottom = 0;

      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const i = (y * width + x) * 4;
          const brightness = (image.data[i] + image.data[i + 1] + image.data[i + 2]) / 3;

          if (x < width / 2) left += brightness;
          else right += brightness;

          if (y < height / 2) top += brightness;
          else bottom += brightness;
        }
      }

      const horizontalTilt = (right - left) / (left + right) * 100;
      const verticalTilt = (bottom - top) / (top + bottom) * 100;

      return { horizontal: horizontalTilt, vertical: verticalTilt };
    }
  </script>
</body>
</html>
